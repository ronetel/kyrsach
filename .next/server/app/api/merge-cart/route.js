(()=>{var e={};e.id=825,e.ids=[825],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},53638:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>w,serverHooks:()=>h,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>m});var a=r(96559),i=r(48088),o=r(37719),n=r(32190),d=r(67155),u=r(55511),c=r.n(u),p=r(68992);let l=async(e,t)=>{try{let r=await d.z.carts.findFirst({where:{userId:e},include:{items:!0}});if(!r)return r=await d.z.carts.create({data:{userId:e,token:c().randomUUID(),totalAmount:0},include:{items:!0}}),console.log("Создана новая корзина для пользователя:",r.id),r;if(t){let e=await d.z.carts.findFirst({where:{token:t,userId:null},include:{items:!0}});if(e){for(let t of(console.log("Объединяем с анонимной корзиной:",e.id),e.items)){let e=r.items.find(e=>e.productItemId===t.productItemId);e?await d.z.cartItems.update({where:{id:e.id},data:{quantity:e.quantity+t.quantity}}):await d.z.cartItems.create({data:{cartId:r.id,productItemId:t.productItemId,quantity:t.quantity}})}await d.z.$transaction([d.z.cartItems.deleteMany({where:{cartId:e.id}}),d.z.carts.delete({where:{id:e.id}})])}else console.log("Анонимная корзина не найдена, работаем с корзиной пользователя")}return await (0,p.q)(void 0,e)}catch(e){throw console.error("Ошибка при работе с корзиной:",e),e}};async function m(e){try{let{userId:t,cartToken:r}=await e.json();if(!t||!r)return n.NextResponse.json({message:"userId и cartToken обязательны"},{status:400});return await l(Number(t),r),n.NextResponse.json({message:"Корзина успешно объединена"})}catch(e){return console.error("[MERGE_CART] Server error at",new Date().toISOString(),e),n.NextResponse.json({message:"Ошибка при объединении корзины"},{status:500})}}let w=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/merge-cart/route",pathname:"/api/merge-cart",filename:"route",bundlePath:"app/api/merge-cart/route"},resolvedPagePath:"C:\\Users\\ronetel\\Desktop\\eyrs\\kyrsach\\app\\api\\merge-cart\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:x,workUnitAsyncStorage:g,serverHooks:h}=w;function y(){return(0,o.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:g})}},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67155:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var s=r(96330);let a=global.prisma||new s.PrismaClient},68992:(e,t,r)=>{"use strict";r.d(t,{q:()=>i});var s=r(67155);let a=e=>e.productItem.Price*e.quantity,i=async(e,t)=>{if(!e&&!t)throw Error("Either token or userId must be provided");let r=await s.z.carts.findFirst({where:{OR:[...e?[{token:e}]:[],...t?[{userId:t}]:[]]},include:{items:{orderBy:{createdAt:"desc"},include:{productItem:{include:{Product:!0,Size:!0}}}}}});if(!r)throw Error("Cart not found");let i=r.items.reduce((e,t)=>e+a(t),0);return await s.z.carts.update({where:{id:r.id},data:{totalAmount:i},include:{items:{include:{productItem:{include:{Product:!0,Size:!0}}}}}})}},78335:()=>{},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[243,580],()=>r(53638));module.exports=s})();