(()=>{var e={};e.id=948,e.ids=[948],e.modules={505:(e,t,r)=>{"use strict";r.d(t,{n:()=>a});var i=r(43205),s=r.n(i);let a=e=>{let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))return null;let r=t.split(" ")[1];try{return s().verify(r,process.env.JWT_SECRET||"")}catch(e){return null}}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48004:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>l,serverHooks:()=>z,workAsyncStorage:()=>I,workUnitAsyncStorage:()=>x});var i={};r.r(i),r.d(i,{GET:()=>p,POST:()=>m});var s=r(96559),a=r(48088),u=r(37719),o=r(32190),d=r(67155),n=r(68992),c=r(505);async function p(e){try{let t=(0,c.n)(e);if(!t)return o.NextResponse.json({message:"Необходима авторизация"},{status:401});let r=Number(t.id),i=await d.z.carts.findFirst({where:{userId:r},include:{items:{include:{productItem:{include:{Product:{select:{ID_Product:!0,name:!0,imageUrl:!0,description:!0}},Size:{select:{ID_Size:!0,Size_name:!0}}}}}}},orderBy:{createdAt:"desc"}});if(!i)return o.NextResponse.json({id:-1,totalAmount:0,items:[]});let s={id:i.id,totalAmount:i.totalAmount,items:i.items.map(e=>({id:e.id,cartId:e.cartId,productItemId:e.productItemId,quantity:e.quantity,price:e.productItem.Price,name:e.productItem.Product.name,imageUrl:e.productItem.Product.imageUrl,pizzaSize:e.productItem.Size?.Size_name||null,description:e.productItem.Product.description||null}))};return o.NextResponse.json(s,{status:200})}catch(e){return console.error("[CARTS_GET] Ошибка:",e),o.NextResponse.json({error:"Ошибка сервера"},{status:500})}}async function m(e){try{let t=(0,c.n)(e);if(!t)return o.NextResponse.json({message:"Необходима авторизация"},{status:401});let r=Number(t.id),i=await d.z.carts.findFirst({where:{userId:r}});i||(i=await d.z.carts.create({data:{userId:r,totalAmount:0}}));let s=await e.json(),a=await d.z.cartItems.findFirst({where:{cartId:i.id,productItemId:s.productItemId}});a?await d.z.cartItems.update({where:{id:a.id},data:{quantity:a.quantity+1}}):await d.z.cartItems.create({data:{cartId:i.id,productItemId:s.productItemId,quantity:1}});let u=await (0,n.q)(void 0,r),p=await d.z.carts.findFirst({where:{id:u.id},include:{items:{include:{productItem:{include:{Product:{select:{ID_Product:!0,name:!0,imageUrl:!0,description:!0}},Size:{select:{ID_Size:!0,Size_name:!0}}}}}}}}),m={id:p.id,totalAmount:p.totalAmount,items:p.items.map(e=>({id:e.id,cartId:e.cartId,productItemId:e.productItemId,quantity:e.quantity,price:e.productItem.Price,name:e.productItem.Product.name,imageUrl:e.productItem.Product.imageUrl,pizzaSize:e.productItem.Size?.Size_name||null,description:e.productItem.Product.description||null}))};return o.NextResponse.json(m,{status:200})}catch(e){return console.log("[CART_POST] Server error",e),o.NextResponse.json({message:"Не удалось добавить товар в корзину"},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/mobile/carts/route",pathname:"/api/mobile/carts",filename:"route",bundlePath:"app/api/mobile/carts/route"},resolvedPagePath:"C:\\Users\\ronetel\\Desktop\\eyrs\\kyrsach\\app\\api\\mobile\\carts\\route.tsx",nextConfigOutput:"",userland:i}),{workAsyncStorage:I,workUnitAsyncStorage:x,serverHooks:z}=l;function w(){return(0,u.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:x})}},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67155:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});var i=r(96330);let s=global.prisma||new i.PrismaClient},68992:(e,t,r)=>{"use strict";r.d(t,{q:()=>a});var i=r(67155);let s=e=>e.productItem.Price*e.quantity,a=async(e,t)=>{if(!e&&!t)throw Error("Either token or userId must be provided");let r=await i.z.carts.findFirst({where:{OR:[...e?[{token:e}]:[],...t?[{userId:t}]:[]]},include:{items:{orderBy:{createdAt:"desc"},include:{productItem:{include:{Product:!0,Size:!0}}}}}});if(!r)throw Error("Cart not found");let a=r.items.reduce((e,t)=>e+s(t),0);return await i.z.carts.update({where:{id:r.id},data:{totalAmount:a},include:{items:{include:{productItem:{include:{Product:!0,Size:!0}}}}}})}},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[243,580,205],()=>r(48004));module.exports=i})();