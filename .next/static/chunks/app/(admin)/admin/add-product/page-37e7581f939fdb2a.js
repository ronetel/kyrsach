(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1821],{7438:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>P});var a=t(95155),s=t(12115),i=t(6874),n=t.n(i),d=t(60714),l=t(62177),o=t(83286),c=t(83463);let u=e=>{var r;let{categories:t,register:s,errors:i}=e;return(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(o.Z,{name:"name",label:"Название",required:!0,className:"mb-4"}),i.name&&(0,a.jsx)("p",{className:"text-red-500",children:i.name.message})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(o.Z,{name:"description",label:"Описание",className:"mb-4"}),i.description&&(0,a.jsx)("p",{className:"text-red-500",children:i.description.message})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(o.Z,{name:"imageUrl",label:"URL изображения",className:"mb-4"}),i.imageUrl&&(0,a.jsx)("p",{className:"text-red-500",children:i.imageUrl.message})]}),(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsxs)("label",{className:"block font-medium mb-2",children:["Категория ",(0,a.jsx)(c.Y,{})]}),(0,a.jsxs)("select",{...s("categoryId",{valueAsNumber:!0}),className:"w-full p-2 bg-[#4A3B3B] text-white rounded h-12 text-md",defaultValue:(null==(r=t[0])?void 0:r.ID_Category)||0,children:[(0,a.jsx)("option",{value:0,disabled:!0,children:"Выберите категорию"}),t.map(e=>(0,a.jsx)("option",{value:e.ID_Category,children:e.Name_categry},e.ID_Category))]}),i.categoryId&&(0,a.jsx)("p",{className:"text-red-500",children:i.categoryId.message})]})]})},m=e=>{var r,t,s,i;let{index:n,sizes:d,register:l,errors:u,onRemove:m}=e;return(0,a.jsxs)("div",{className:"flex gap-2 mb-2 items-center",children:[(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsxs)("label",{className:"block font-medium mb-2",children:["Размер ",(0,a.jsx)(c.Y,{})]}),(0,a.jsx)("select",{...l("sizes.".concat(n,".sizeId"),{valueAsNumber:!0}),className:"w-full p-2 bg-[#4A3B3B] text-white rounded h-12 text-md",children:d.map(e=>(0,a.jsx)("option",{value:e.ID_Size,children:e.Size_name},e.ID_Size))}),(null==(t=u.sizes)||null==(r=t[n])?void 0:r.sizeId)&&(0,a.jsx)("p",{className:"text-red-500",children:u.sizes[n].sizeId.message})]}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)(o.Z,{name:"sizes.".concat(n,".price"),label:"Цена (₽)",type:"number",required:!0,className:"mb-4"}),(null==(i=u.sizes)||null==(s=i[n])?void 0:s.price)&&(0,a.jsx)("p",{className:"text-red-500",children:u.sizes[n].price.message})]}),n>0&&(0,a.jsx)("button",{type:"button",onClick:()=>m(n),className:"p-2 bg-[#D32F2F] text-white rounded hover:bg-[#b71c1c] mt-8",children:"Удалить"})]})},p=e=>{let{isPizza:r,sizes:t,sizesArray:s,register:i,errors:n,addSizeToProduct:d,removeSize:l}=e;return(0,a.jsx)(a.Fragment,{children:r?(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Размеры и цены"}),(!s||0===s.length)&&(0,a.jsx)("p",{className:"text-red-500 mb-2",children:"Добавьте хотя бы один размер для пиццы"}),null==s?void 0:s.map((e,r)=>(0,a.jsx)(m,{index:r,sizes:t,register:i,errors:n,onRemove:l},r)),(0,a.jsx)("button",{type:"button",onClick:d,className:"mt-2 bg-[#D32F2F] text-white px-4 py-2 rounded hover:bg-[#b71c1c]",children:"Добавить размер"})]}):(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsx)(o.Z,{name:"price",label:"Цена (₽)",type:"number",required:!0,className:"mb-4"}),n.price&&(0,a.jsx)("p",{className:"text-red-500",children:n.price.message})]})})};var g=t(90221),v=t(55594),h=t(13568),x=t(56053);let b=v.Ik({name:v.Yj().min(2,{message:"Название должно содержать не менее 2 символов"}),description:v.Yj().optional(),imageUrl:v.Yj().optional(),categoryId:v.ai().min(1,{message:"Выберите категорию"}),price:v.Yj().optional().refine(e=>!e||Number(e)>0,{message:"Цена должна быть больше 0"}),sizes:v.YO(v.Ik({sizeId:v.ai().min(1,{message:"Выберите размер"}),price:v.Yj().refine(e=>Number(e)>0,{message:"Цена должна быть больше 0"})})).optional()}),f=()=>{var e,r;let{categories:t,sizes:a,loading:i,fetchAdminData:n,addProduct:d}=(0,x.g)(),o=(0,l.mN)({resolver:(0,g.u)(b),defaultValues:{name:"",description:"",imageUrl:"",categoryId:(null==(e=t[0])?void 0:e.ID_Category)||0,price:"",sizes:[]}}),{watch:c,setValue:u,reset:m}=o,p=c("categoryId"),v=null==(r=t.find(e=>e.ID_Category===p))?void 0:r.Name_categry,f="Пиццы"===v,y=c("sizes")||[];(0,s.useEffect)(()=>{t.length&&a.length||n()},[n,t.length,a.length]);let j=async e=>{var r;if(i)return;if(f&&(!e.sizes||0===e.sizes.length))return void h.Ay.error("Добавьте хотя бы один размер для пиццы",{icon:"❌"});if(!f&&!e.price)return void h.Ay.error("Укажите цену для продукта",{icon:"❌"});let t={name:e.name,description:e.description||void 0,imageUrl:e.imageUrl||void 0,categoryId:e.categoryId,sizes:f?null==(r=e.sizes)?void 0:r.map(e=>({sizeId:e.sizeId,price:Number(e.price)})):e.price?[{sizeId:null,price:Number(e.price)}]:[]};await d(t),m()};return{form:o,categories:t,sizes:a,loading:i,selectedCategory:v,isPizza:f,sizesArray:y,addSizeToProduct:()=>{var e;if(!(null==(e=a[0])?void 0:e.ID_Size))return void h.Ay.error("Нет доступных размеров",{icon:"❌"});u("sizes",[...y||[],{sizeId:a[0].ID_Size,price:""}],{shouldValidate:!0})},removeSize:e=>{u("sizes",y.filter((r,t)=>t!==e),{shouldValidate:!0})},handleSubmit:j}},y=()=>{let{form:e,categories:r,sizes:t,loading:s,selectedCategory:i,isPizza:n,sizesArray:d,addSizeToProduct:o,removeSize:c,handleSubmit:m}=f(),{formState:{errors:g},register:v}=e;return s?(0,a.jsx)("p",{className:"text-white text-center mt-10",children:"Загрузка..."}):(0,a.jsxs)("section",{className:"mb-10",children:[0===r.length&&(0,a.jsx)("p",{className:"text-red-500 mb-4",children:"Категории не загружены"}),n&&0===t.length&&(0,a.jsx)("p",{className:"text-red-500 mb-4",children:"Размеры не загружены"}),(0,a.jsx)(l.Op,{...e,children:(0,a.jsxs)("form",{onSubmit:e.handleSubmit(m),className:"bg-[#3A2B2B] p-6 rounded-lg shadow-lg",children:[Object.keys(g).length>0&&(0,a.jsx)("p",{className:"text-red-500 mb-4",children:"Проверьте правильность заполнения формы"}),(0,a.jsx)(u,{categories:r,register:v,errors:g}),(0,a.jsx)(p,{isPizza:n,sizes:t,sizesArray:d,register:v,errors:g,addSizeToProduct:o,removeSize:c}),(0,a.jsx)("button",{type:"submit",className:"mt-4 bg-[#D32F2F] text-white px-4 py-2 rounded hover:bg-[#b71c1c]",disabled:s,children:"Добавить товар"})]})})]})};var j=t(53632),N=t(25943),w=t(78100),I=t(46671);let _=t.g.prisma||new I.PrismaClient;var k=t(57599),z=t(58801),S=t.n(z),A=t(87358);let C={providers:[(0,w.A)({clientId:A.env.GOOGLE_CLIENT_ID||"",clientSecret:A.env.GOOGLE_CLIENT_SECRET||""}),(0,N.A)({name:"Credentials",credentials:{email:{label:"Email",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){if(!e)return null;let r=await _.users.findFirst({where:{Email_user:e.email}});if(!r||!await (0,k.UD)(e.password,r.Password_user)||!r.verified)return null;let t=S().sign({id:r.ID_User,email:r.Email_user},A.env.JWT_SECRET||"");return{id:r.ID_User,email:r.Email_user,name:r.Name_user,role:r.role,token:t}}})],secret:A.env.NEXTAUTH_SECRET,session:{strategy:"jwt"},callbacks:{async signIn(e){let{user:r,account:t,profile:a}=e;try{if((null==t?void 0:t.provider)==="credentials"&&r.id&&r.token){let e=await fetch("/api/merge-cart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:Number(r.id),cartToken:r.token})});e.ok||console.error("Failed to merge cart:",await e.text())}if(!r.email)return!1;let e=await _.users.findFirst({where:{OR:[{provider:null==t?void 0:t.provider,providerId:null==t?void 0:t.providerAccountId},{Email_user:r.email}]}});if(e){if(await _.users.update({where:{ID_User:e.ID_User},data:{provider:null==t?void 0:t.provider,providerId:null==t?void 0:t.providerAccountId}}),(null==t?void 0:t.provider)==="google"&&r.id&&r.token){let e=await fetch("/api/merge-cart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:Number(r.id),cartToken:r.token})});e.ok||console.error("Failed to merge cart:",await e.text())}return!0}let a=await _.users.create({data:{Email_user:r.email,Name_user:r.name||"User #"+r.id,Password_user:(0,k.Y8)(r.email,10),verified:new Date,provider:null==t?void 0:t.provider,providerId:null==t?void 0:t.providerAccountId}});if((null==t?void 0:t.provider)==="google"&&a.ID_User&&r.token){let e=await fetch("/api/merge-cart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:a.ID_User,cartToken:r.token})});e.ok||console.error("Failed to merge cart:",await e.text())}return!0}catch(e){return console.error("Error [SIGNIN]",e),!1}},async jwt(e){let{token:r,user:t}=e;if(t&&(r.id=Number(t.id),r.email=t.email,r.fullName=t.name,r.role=t.role,r.token=t.token),!r.email)return r;let a=await _.users.findFirst({where:{Email_user:r.email}});return a&&(r.id=a.ID_User,r.email=a.Email_user,r.fullName=a.Name_user,r.role=a.role),r},async session(e){let{session:r,token:t}=e;return(null==r?void 0:r.user)&&(r.user.id=Number(t.id),r.user.role=t.role,r.user.token=t.token),r}}},D=async()=>{var e;let r=await (0,j.getServerSession)(C);return null!=(e=null==r?void 0:r.user)?e:null};var E=t(35695);async function P(){let e=await D();if(!e)return(0,E.redirect)("/not-auth");let r=await _.users.findFirst({where:{ID_User:Number(e.id)}});if(!r||"Admin"!==r.role)return(0,E.redirect)("/not-auth");let{loading:t,fetchAdminData:i}=(0,x.g)();return((0,s.useEffect)(()=>{i()},[i]),t)?(0,a.jsx)("div",{className:"text-white text-center mt-10",children:"Загрузка..."}):(0,a.jsxs)("div",{className:"min-h-screen bg-main text-white p-6",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold",children:"Добавить товар"}),(0,a.jsx)(n(),{href:"/admin",children:(0,a.jsx)(d.$,{variant:"red",children:"Назад"})})]}),(0,a.jsx)(y,{})]})}},19825:()=>{},29386:(e,r,t)=>{Promise.resolve().then(t.bind(t,7438))},39029:(e,r,t)=>{"use strict";t.d(r,{k:()=>n});var a=t(95155),s=t(54416);t(12115);var i=t(46457);let n=e=>{let{onClick:r,className:t}=e;return(0,a.jsx)("button",{onClick:r,className:(0,i.cn)("absolute right-4 top-1/2 -translate-y-1/2 opacity-30 hover:opacity-100 cursor-pointer",t),children:(0,a.jsx)(s.A,{className:"h-5 w-5"})})}},42390:(e,r,t)=>{"use strict";t.d(r,{j:()=>I});var a={};t.r(a),t.d(a,{addCartItem:()=>p,getCart:()=>c,removeCartItem:()=>m,updateItemQuantity:()=>u});var s={};t.r(s),t.d(s,{getMe:()=>g});var i={};t.r(i),t.d(i,{search:()=>h});var n={};t.r(n),t.d(n,{addProduct:()=>w,deleteProduct:()=>N,getCategories:()=>x,getOrders:()=>y,getProducts:()=>f,getSizes:()=>b,updateOrderStatus:()=>j});var d=t(23464),l=t(87358);let o=d.A.create({baseURL:l.env.NEXT_PUBLIC_API_URL}),c=async()=>(await o.get("/api/carts")).data,u=async(e,r)=>(await o.patch("/api/carts/"+e,{quantity:r})).data,m=async e=>(await o.delete("/api/carts/"+e)).data,p=async e=>(await o.post("/api/carts",e)).data,g=async()=>{let{data:e}=await o.get("api/auth/me");return e};var v=function(e){return e.SEARCH_PRODUCTS="api/products/search",e}({});let h=async e=>(await o.get(v.SEARCH_PRODUCTS,{params:{query:e}})).data,x=async()=>(await o.get("/api/categories")).data,b=async()=>(await o.get("/api/sizes")).data,f=async()=>(await o.get("/api/products")).data,y=async()=>(await o.get("/api/orders")).data,j=async(e,r)=>(await o.patch("/api/admin/orders/".concat(e,"/status"),r)).data,N=async e=>{await o.delete("/api/products/".concat(e))},w=async e=>(await o.post("/api/products",e)).data,I={cart:a,auth:s,products:i,admin:n}},46457:(e,r,t)=>{"use strict";t.d(r,{cn:()=>i});var a=t(52596),s=t(39688);function i(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return(0,s.QP)((0,a.$)(r))}},56053:(e,r,t)=>{"use strict";t.d(r,{g:()=>n});var a=t(65453),s=t(13568),i=t(42390);let n=(0,a.v)((e,r)=>({categories:[],sizes:[],products:[],orders:[],loading:!0,error:!1,fetchAdminData:async()=>{try{e({loading:!0,error:!1});let[r,t,a,s]=await Promise.all([i.j.admin.getCategories(),i.j.admin.getSizes(),i.j.admin.getProducts(),i.j.admin.getOrders()]);e({categories:r,sizes:t,products:a,orders:s})}catch(r){console.error("Fetch admin data error:",r),e({error:!0}),s.Ay.error("Ошибка загрузки данных",{icon:"❌"})}finally{e({loading:!1})}},updateOrderStatus:async(r,t)=>{try{e({loading:!0,error:!1}),await i.j.admin.updateOrderStatus(r,{status:t}),e(e=>({orders:e.orders.map(e=>e.id===r?{...e,status:t}:e)})),s.Ay.success("Статус заказа обновлён",{icon:"✅"})}catch(r){console.error("Update order status error:",r),e({error:!0}),s.Ay.error("Не удалось обновить статус",{icon:"❌"})}finally{e({loading:!1})}},deleteProduct:async r=>{try{e({loading:!0,error:!1}),await i.j.admin.deleteProduct(r),e(e=>({products:e.products.filter(e=>e.ID_Product!==r)})),s.Ay.success("Товар удалён",{icon:"✅"})}catch(r){console.error("Delete product error:",r),e({error:!0}),s.Ay.error("Не удалось удалить товар",{icon:"❌"})}finally{e({loading:!1})}},addProduct:async r=>{try{e({loading:!0,error:!1});let t=await i.j.admin.addProduct(r);e(e=>({products:[t,...e.products]})),s.Ay.success("Товар добавлен",{icon:"✅"})}catch(r){console.error("Add product error:",r),e({error:!0}),s.Ay.error("Не удалось добавить товар",{icon:"❌"})}finally{e({loading:!1})}}}))},60714:(e,r,t)=>{"use strict";t.d(r,{$:()=>o});var a=t(95155),s=t(12115),i=t(99708),n=t(74466),d=t(46457);let l=(0,n.F)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",{variants:{variant:{default:"bg-dop-bg text-black shadow-xs hover:bg-dop-bg/90 rounded-2xl",red:"bg-mint-500 shadow-xs hover:bg-mint-500/90 rounded-3xl",destructive:"bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",outline:"border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",secondary:"bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-9 px-4 py-2 has-[>svg]:px-3",sm:"h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",lg:"h-10 rounded-md px-6 has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}}),o=s.forwardRef((e,r)=>{let{className:t,variant:s,size:n,asChild:o=!1,loading:c,children:u,...m}=e,p=o?i.Slot:"button";return(0,a.jsx)(p,{"data-slot":"button",className:(0,d.cn)(l({variant:s,size:n,className:t}),c&&"opacity-75 pointer-events-none"),disabled:!!c,"aria-busy":!!c,ref:r,...m,children:c?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:"inline-block h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),u]}):u})});o.displayName="Button"},83286:(e,r,t)=>{"use strict";t.d(r,{Z:()=>c});var a=t(95155),s=t(62177);t(12115);var i=t(46457);function n(e){let{className:r,type:t,...s}=e;return(0,a.jsx)("input",{type:t,"data-slot":"input",className:(0,i.cn)("file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm","focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]","aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",r),...s})}var d=t(91155),l=t(83463),o=t(39029);let c=e=>{var r;let{className:t,name:i,label:c,required:u,...m}=e,{register:p,formState:{errors:g},watch:v,setValue:h}=(0,s.xW)(),x=v(i),b=null==(r=g[i])?void 0:r.message;return(0,a.jsxs)("div",{className:t,children:[c&&(0,a.jsxs)("p",{className:"font-medium mb-2",children:[c," ",u&&(0,a.jsx)(l.Y,{})]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(n,{className:"h-12 text-md",...p(i),...m}),x&&(0,a.jsx)(o.k,{onClick:()=>{h(i,"",{shouldValidate:!0})}})]}),b&&(0,a.jsx)(d.y,{text:b,className:"mt-2"})]})}},83463:(e,r,t)=>{"use strict";t.d(r,{Y:()=>s});var a=t(95155);t(12115);let s=()=>(0,a.jsx)("span",{className:"text-red-500",children:"*"})},91155:(e,r,t)=>{"use strict";t.d(r,{y:()=>i});var a=t(95155);t(12115);var s=t(46457);let i=e=>{let{text:r,className:t}=e;return(0,a.jsx)("p",{className:(0,s.cn)("text-red-500 text-sm",t),children:r})}}},e=>{var r=r=>e(e.s=r);e.O(0,[9268,9352,3568,5604,3892,6874,7707,2352,8441,1684,7358],()=>r(29386)),_N_E=e.O()}]);